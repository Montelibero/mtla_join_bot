# MTLA Join Bot

Телеграм-бот для проверки формальных критериев и подготовки заявки на вступление в МТЛА (Международная Токеномическая Лига Ассоциаций).

## Возможности

- Пошаговая проверка критериев вступления
- Автоматическое определение языка пользователя (русский/английский)
- Проверка наличия юзернейма
- Согласие с условиями Соглашения
- Ввод и проверка Стеллар адреса
- Проверка линии доверия к токену MTLAP
- **Проверка рекомендаций от верифицированных участников МТЛА**
- **Интеграция с BSN Expert для проверки рекомендаций**
- **Умный интерфейс с обычными клавиатурными кнопками**
- **Раздельные сообщения для каждой проблемы**
- Мультиязычный интерфейс
- **Сохрание данных в MongoDB**
- **Отслеживание прогресса пользователей**
- **Административные инструменты для анализа**

## Требования

- Python 3.8+
- MongoDB 4.0+
- Доступ к интернету для работы с Telegram API и Stellar Network
- Доступ к BSN Expert API для проверки рекомендаций

## Установка

### Вариант 1: Локальная установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd MTLA_join_bot
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Установите и запустите MongoDB:
```bash
# Ubuntu/Debian
sudo apt-get install mongodb

# macOS (с Homebrew)
brew install mongodb-community
brew services start mongodb-community

# Или используйте Docker
docker run -d -p 27017:27017 --name mongodb mongo:latest
```

4. Создайте файл `.env` на основе `env_example.txt`:
```bash
cp env_example.txt .env
```

5. Отредактируйте `.env` файл, указав:
   - `TELEGRAM_TOKEN` - токен вашего бота от @BotFather
   - `MONGODB_URI` - URI для подключения к MongoDB
   - `MONGODB_DB` - название базы данных
   - `MONGODB_COLLECTION` - название коллекции
   - `STELLAR_NETWORK` - сеть Стеллар (public или testnet)
   - `MTLAP_ASSET` - адрес токена MTLAP
   - `ADMIN_IDS` - ID администраторов через запятую (например: 123456789,987654321)

## Запуск

### Локальный запуск

```bash
python main.py
```

### Запуск в Docker

1. **Убедитесь, что установлен Docker**

2. **Создайте файл `.env` на основе `env_example.txt`**:
   ```bash
   cp env_example.txt .env
   # Отредактируйте .env файл, указав TELEGRAM_TOKEN и ADMIN_IDS
   ```

3. **Запустите бота**:
   ```bash
   # Собрать образ и запустить
   ./docker-simple.sh build && ./docker-simple.sh run
   
   # Или по отдельности
   ./docker-simple.sh build
   ./docker-simple.sh run
   ```

4. **Проверьте статус**:
   ```bash
   ./docker-simple.sh status
   ```

5. **Посмотрите логи**:
   ```bash
   ./docker-simple.sh logs
   ```

6. **Остановите бота**:
   ```bash
   ./docker-simple.sh stop
   ```

#### Docker команды

- **Сборка образа**: `./docker-simple.sh build`
- **Запуск**: `./docker-simple.sh run`
- **Остановка**: `./docker-simple.sh stop`
- **Логи**: `./docker-simple.sh logs`
- **Перезапуск**: `./docker-simple.sh restart`
- **Очистка**: `./docker-simple.sh clean`
- **Войти в контейнер**: `./docker-simple.sh shell`

## Структура проекта

```
MTLA_join_bot/
├── src/
│   └── mtla_bot/           # Основной пакет
│       ├── __init__.py     # Инициализация пакета
│       ├── bot.py          # Основной файл бота
│       ├── config.py       # Конфигурация и настройки
│       ├── stellar_client.py # Клиент для работы со Стеллар блокчейном
│       ├── user_states.py  # Управление состояниями пользователей
│       ├── database.py     # Модуль для работы с MongoDB
│       ├── admin_tools.py  # Административные инструменты
│       ├── admin_config.py # Конфигурация администраторов
│       └── messages.py     # Тексты сообщений на разных языках
├── main.py                 # Точка входа для запуска
├── requirements.txt        # Зависимости проекта
├── Dockerfile             # Docker образ
├── docker-simple.sh       # Скрипт управления Docker
└── .env                   # Переменные окружения
```

### Docker файлы

- `Dockerfile` - образ с Python + MongoDB
- `.dockerignore` - исключения для Docker контекста
- `docker-simple.sh` - простой скрипт управления Docker контейнером

## Команды бота

- `/start` - начать процесс проверки
- `/restart` - начать заново
- `/language` - сменить язык

## Административные команды

Бот поддерживает административные команды для мониторинга и анализа:

- `/stats` - показывает статистику по пользователям
- `/incomplete` - показывает незавершенных пользователей
- `/reminders [дни]` - показывает кандидатов для напоминания (по умолчанию 7 дней)
- `/user_info <user_id>` - показывает детали конкретного пользователя
- `/help_admin` - показывает справку по административным командам

### Настройка администраторов

1. Получите ваш Telegram ID у бота @userinfobot
2. Добавьте ваш ID в переменную `ADMIN_IDS` в файле `.env`
3. Перезапустите бота

**Пример в .env файле:**
```bash
ADMIN_IDS=123456789,987654321
```

**Примечание:** Администраторы теперь настраиваются через переменные окружения для большей безопасности.

## Процесс проверки

1. **Проверка юзернейма** - проверяется наличие username у пользователя
2. **Согласие с условиями** - пользователь должен согласиться с Соглашением
3. **Ввод Стеллар адреса** - пользователь вводит свой адрес с возможностью получить справку
4. **Проверка адреса** - проверяется существование адреса и линия доверия к MTLAP
5. **Проверка рекомендаций** - проверяется наличие рекомендации от верифицированного участника (минимум 2 MTLAP токена)
6. **Завершение** - если все проверки пройдены, генерируется текст заявки для копирования

### Особенности интерфейса

- **Обычные клавиатурные кнопки** вместо inline кнопок для лучшего UX
- **Раздельные сообщения** для каждой проблемы (не один длинный список)
- **Автоматическое очищение кнопок** при переходе между шагами
- **Контекстная помощь** с ссылками на статьи и чаты

## База данных MongoDB

Бот использует MongoDB для хранения данных пользователей. Структура документа пользователя:

```json
{
  "user_id": 123456789,
  "username": "username",
  "language": "ru",
  "state": "checking_username",
  "stellar_address": "G...",
  "has_username": true,
  "agreed_to_terms": true,
  "has_trustline": true,
  "has_recommendation": false,
  "recommender_username": null,
  "created_at": "2024-01-01T00:00:00Z",
  "last_activity": "2024-01-01T00:00:00Z",
  "progress": {
    "username_check": true,
    "agreement": true,
    "address_entered": true,
    "trustline_check": true,
    "recommendation": false
  }
}
```

### Новые поля для рекомендаций

Бот также проверяет и сохраняет информацию о рекомендациях:
- **has_recommendation** - есть ли верифицированная рекомендация
- **has_any_recommendation** - есть ли любая рекомендация
- **recommendation_details** - детали найденных рекомендаций

## Административные функции

Модуль `admin_tools.py` предоставляет инструменты для анализа данных:

```python
from admin_tools import AdminTools

admin = AdminTools()

# Получить статистику
stats = admin.get_user_statistics()

# Получить незавершенных пользователей
incomplete = admin.get_incomplete_users_report()

# Получить кандидатов для напоминания
reminders = admin.get_reminder_candidates(days_inactive=7)

# Получить детали пользователя
user_details = admin.get_user_details(user_id=123456789)
```

## Новые функции

### Проверка рекомендаций

Бот интегрирован с [BSN Expert](https://bsn.expert) для проверки рекомендаций:
- Автоматическая загрузка данных о рекомендациях
- Проверка верификации рекомендателя (минимум 2 MTLAP токена)
- Информативные сообщения о статусе рекомендаций
- Ссылки на чат Площади для получения рекомендаций

### Улучшенный интерфейс

- **Обычные клавиатурные кнопки** для лучшего UX
- **Раздельные сообщения** для каждой проблемы
- **Автоматическое очищение кнопок** при переходах
- **Контекстная помощь** с эмодзи и ссылками

## Настройка

### Ссылки и конфигурация

В файле `config.py` можно настроить:
- Ссылки на инструкции и статьи
- Адрес токена MTLAP
- Сеть Стеллар (mainnet/testnet)
- Параметры подключения к MongoDB
- Ссылки на чаты и боты для помощи

### Добавление новых языков

В файле `messages.py` добавьте новый язык в словарь `MESSAGES` и соответствующие ссылки в `config.py`.

## Мониторинг и аналитика

Бот автоматически отслеживает:
- Прогресс каждого пользователя
- Время создания и последней активности
- Распределение пользователей по состояниям
- Пользователей для напоминания

## Разработка

Бот написан на Python 3.8+ с использованием:
- `python-telegram-bot` - для работы с Telegram API
- `stellar-sdk` - для работы со Стеллар блокчейном
- `pymongo` - для работы с MongoDB
- `python-dotenv` - для загрузки переменных окружения
- `aiohttp` - для асинхронных HTTP запросов к BSN Expert
- `ssl` - для безопасного подключения к внешним API

## Лицензия

MIT License
